name: Cubica Mail Manager Cron

on:
  schedule:
    # sync-email cada 10 minutos
    - cron: "*/10 * * * *"
    # notificar-pendientes todos los días a las 13:00 UTC (8:00am Colombia)
    - cron: "0 13 * * *"
  # Permite ejecutar el workflow manualmente
  workflow_dispatch:

jobs:
  cron-jobs:
    runs-on: ubuntu-latest

    steps:
      - name: Llamar sync-email (cada 10 min)
        if: github.event_name == 'schedule' && github.event.schedule == '*/10 * * * *'
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.RENDER_BASE_URL }}/api/cotizaciones/sync-email/cron" \
            -d '{"maxMessages":50}'

      - name: Llamar notificar-pendientes (diario 8am CO)
        if: github.event_name == 'schedule' && github.event.schedule == '0 13 * * *'
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.RENDER_BASE_URL }}/api/cotizaciones/notificar-pendientes/cron" \
            -d '{"minutosUmbral":1440}'

      - name: Ejecutar ambos jobs (ejecución manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Llamando sync-email y notificar-pendientes manualmente"

          curl -X POST \
            -H "Content-Type: application/json" \
              -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
              "${{ secrets.RENDER_BASE_URL }}/api/cotizaciones/sync-email/cron" \
              -d '{"maxMessages":50}'

          curl -X POST \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.RENDER_BASE_URL }}/api/cotizaciones/notificar-pendientes/cron" \
            -d '{"minutosUmbral":1440}'
